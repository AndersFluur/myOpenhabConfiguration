import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*
 
import org.joda.time.*
 
var Timer tIndoorLights
 
rule "React to sunset"
when
        Time cron "0 15 13 * * ?"   // Every day 13:15 hours, evaluate sunset
then
    var year   = now.getYear
    var month  = now.getMonthOfYear
    var day    = now.getDayOfMonth
    var datum  = year+"-"+month+"-"+day+" "+ SunSetTime.state
    logInfo("Sunset","datum = " + datum)
    var DateTime sunset = parse(year+"-"+month+"-"+day+"T"+ SunSetTime.state)
    var minutes = 15  // minutes before sunset
 
    /*
     * Indoor Lights
     */
 
    // Cancel timer to avoid reschedule
    if(tIndoorLights!=null) {
        logInfo("Sunset","Timer tIndoorLights cancelled")
        tIndoorLights.cancel()
    }
    logInfo("Sunset","Timer tIndoorLights created")
    tIndoorLights = createTimer(sunset.minusMinutes(minutes)) [|
        logInfo("Sunset","Timer tIndoorLights executed")
        
        sendCommand(Z_Fireplace, ON)
        sendCommand(Z_Dining, ON)
        
    ]
end